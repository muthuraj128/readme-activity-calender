name: CI + CD (Post-Merge Only)

on:
  push:
    branches: [main]  # Only trigger after merge into main

permissions:
  contents: write  # Required for GitHub Pages deployment

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout code
        uses: actions/checkout@v4

      - name: âœ… JavaScript Syntax Check
        run: |
          js_files=$(find . -name "*.js" -not -path "./node_modules/*" | head -20)
          if [ -z "$js_files" ]; then
            echo "No JavaScript files found - skipping JS validation"
          else
            echo "Found JavaScript files - running syntax check..."
            for file in $js_files; do
              echo "Checking JS: $file"
              node -c "$file" || exit 1
            done
            echo "âœ… All JavaScript files passed syntax check!"
          fi

      - name: âœ… CSS Validation
        run: |
          css_files=$(find . -name "*.css" -not -path "./node_modules/*" | head -10)
          if [ -z "$css_files" ]; then
            echo "No CSS files found - skipping CSS validation"
          else
            echo "Found CSS files - running validation..."
            for file in $css_files; do
              echo "Checking CSS: $file"
              # Simple CSS syntax check - look for basic structure
              if ! grep -q "{" "$file" || ! grep -q "}" "$file"; then
                echo "Warning: $file might not be valid CSS"
              fi
            done
            echo "âœ… CSS files checked!"
          fi

      - name: âœ… HTML Validation
        run: |
          html_files=$(find . -name "*.html" -not -path "./node_modules/*" | head -10)
          if [ -z "$html_files" ]; then
            echo "No HTML files found - skipping HTML validation"
          else
            echo "Found HTML files - running validation..."
            for file in $html_files; do
              echo "Checking HTML: $file"
              # Basic HTML check - ensure it has proper structure
              if ! grep -q "<html" "$file" && ! grep -q "<!DOCTYPE" "$file"; then
                echo "Warning: $file might not be valid HTML"
              fi
            done
            echo "âœ… HTML files checked!"
          fi

      - name: âœ… Markdown Validation
        run: |
          echo "Validating Markdown files..."
          for file in $(find . -name "*.md"); do
            echo "Checking: $file"
            if [ ! -s "$file" ]; then
              echo "Error: $file is empty"
              exit 1
            fi
          done
          echo "âœ… All Markdown files are valid!"

      - name: âœ… Check Required Files
        run: |
          echo "Checking for required repository files..."
          required_files=("README.md" "LICENSE" "CONTRIBUTING.md")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Error: Missing required file: $file"
              exit 1
            else
              echo "âœ“ Found: $file"
            fi
          done

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: ðŸ§¾ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./  # Deploy all repository content including README.md
